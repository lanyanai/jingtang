window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60)}})();var ajaxSubjectGame={"count":0,"total_size":0,"start_position":1,"init_size":20,"rescategory_id":38,"order_by":"new","contentUrl":$.apiRoot+"appV3/getTopicById.do","appUrl":$.apiRoot+"appV3/getCategoryProducts.do","detailUrl":$.htmlRoot+"game_detail.html","countUrl":$.apiRoot+"worldcup/getLotteryCnt.do","lotteryUrl":$.apiRoot+"worldcup/getLotteryResult.do","giftUrl":$.htmlRoot+"gift_detail.html","infoUrl":$.apiRoot+"worldcup/saveLotteryInfo.do"};var subjectGameList=[];function createItem(itemData,$tem){var $item=$tem.clone();fillItem($item,itemData);return $item}function updateState(packageName,state){var $item=$(document.getElementById(packageName));var $btn=$item.find(".btn");if(state>=0&&state<=100){if(!$btn.hasClass("cancelBtn")){$btn.removeClass().addClass("cancelBtn btn")}$item.find(".state").text(state+"%")}else{if(state=="finishDownload"){$btn.removeClass().addClass("installBtn btn");$item.find(".state").text("安装")}else{if(state=="finishInstall"){$btn.removeClass().addClass("openBtn btn");$item.find(".state").text("打开")}else{if(state=="pause"){$btn.removeClass().addClass("continueBtn btn");$item.find(".state").text("继续")}}}}}function indexList(packageName,list){var len=list.length;for(var i=0;i<len;++i){if(packageName==list[i].resPackagename){return i}}return -1}function fillRate($item,score){$item.find(".items-score img").each(function(j,imgItem){if(j-score<-0.5){$(imgItem).attr("src",star_01)}else{if(j-score==-0.5){$(imgItem).attr("src",star_02)}else{$(imgItem).attr("src",star_03)}}})}function fillState($item,packageName,phoneData){var downloadIndex=indexList(packageName,phoneData.downloadList);if(downloadIndex!=-1){if(phoneData.downloadList[downloadIndex].downPercent==100){$item.find(".state").text("安装");$item.find(".btn").removeClass().addClass("btn installBtn")}else{$item.find(".state").text("继续");$item.find(".btn").removeClass().addClass("btn continueBtn")}}else{if(indexList(packageName,phoneData.updateList)!=-1){$item.find(".state").text("升级");$item.find(".btn").removeClass().addClass("btn updateBtn")}else{if(indexList(packageName,phoneData.installList)!=-1){$item.find(".state").text("打开");$item.find(".btn").removeClass().addClass("btn openBtn")}else{$item.find(".state").text("下载");$item.find(".btn").removeClass().addClass("btn dlBtn")}}}}function indexOfGift(acId){var len=myGiftData.length;for(var i=0;i<len;++i){if(myGiftData[i].acId===acId){return i}}return -1}function fillItem($item,itemData){var packageName=itemData.resPackagename;$item.attr("id",itemData.resPackagename).data("location",itemData.resLocation).data("id",itemData.resId).data("package",packageName).data("icon",itemData.resIcons).data("name",itemData.resName);if(itemData.acId){var index=indexOfGift(itemData.acId);if(index!=-1){$item.find(".relate-gift").show().on("tap",function(){isUxbao&&window.uxbao.click(JSON.stringify({"type":12,"title":itemData.acName,"url":$.htmlRoot+"gift_detail.html"+"?acId="+itemData.acId+"&num="+myGiftData[index].giftNo}));return false})}else{$item.find(".relate-gift").show().on("tap",function(){isUxbao&&window.uxbao.click(JSON.stringify({"type":12,"title":itemData.acName,"url":$.htmlRoot+"gift_detail.html"+"?acId="+itemData.acId}));return false})}}else{$item.find(".relate-gift").hide().off("tap")}$item.find(".appIcon").data("icon",itemData.resIcons).attr("src",default_icon);$item.find(".tit strong").text(itemData.resName);var ca=(itemData.resCapacity/(1024*1024)).toFixed(1);$item.find(".tit p").text(ca+"MB | "+itemData.resDeveloper);var rated=itemData.resRated;fillRate($item,rated);fillState($item,packageName,phoneData)}function btnTapHandler($target){var $item=$target.parent().parent();if($target.hasClass("dlBtn")){++ajaxSubjectGame.count;$("#lotteryCount").text(ajaxSubjectGame.count+"次")}if($target.hasClass("dlBtn")||$target.hasClass("continueBtn")){$target.removeClass().addClass("cancelBtn btn");$target.find(".state").text("暂停");isUxbao&&window.uxbao.click(JSON.stringify({"type":1,"resPackagename":$item.data("package"),"resId":$item.data("id"),"resLocation":$item.data("location"),"resIcons":$item.data("icon"),"resName":$item.data("name")}))}else{if($target.hasClass("updateBtn")){$target.removeClass("updateBtn").addClass("cancelBtn");$target.find(".state").text("暂停");isUxbao&&window.uxbao.click(JSON.stringify({"type":1,"resPackagename":$item.data("package"),"resId":$item.data("id"),"resLocation":$item.data("location"),"resIcons":$item.data("icon"),"resName":$item.data("name")}))}else{if($target.hasClass("cancelBtn")){$target.removeClass("cancelBtn").addClass("continueBtn");$target.find(".state").text("继续");isUxbao&&window.uxbao.click(JSON.stringify({"type":5,"resPackagename":$item.data("package"),"resId":$item.data("id"),"resLocation":$item.data("location"),"resIcons":$item.data("icon"),"resName":$item.data("name")}))
}else{if($target.hasClass("openBtn")){isUxbao&&window.uxbao.click(JSON.stringify({"type":3,"resPackagename":$item.data("package"),"resId":$item.data("id"),"resLocation":$item.data("location"),"resIcons":$item.data("icon"),"resName":$item.data("name")}))}else{if($target.hasClass("installBtn")){isUxbao&&window.uxbao.click(JSON.stringify({"type":6,"resPackagename":$item.data("package"),"resId":$item.data("id"),"resLocation":$item.data("location"),"resIcons":$item.data("icon"),"resName":$item.data("name")}))}}}}}}function infoTapHandler($info){var $item=$info.parent().parent();var resId=$item.data("id");isUxbao&&window.uxbao.click(JSON.stringify({"type":2,"resId":resId,"url":ajaxSubjectGame.detailUrl+"?resId="+resId,"resName":$item.data("name"),"resPackageName":$item.data("package")}))}function getDateStr(date){var dateStr="";dateStr+=date.getFullYear();var month=date.getMonth()+1;var day=date.getDate();if(month<10){dateStr+=".0"+month}else{dateStr+="."+month}if(day<10){dateStr+=".0"+day}else{dateStr+="."+day}return dateStr}function fRandomBy(under,over){switch(arguments.length){case 1:return parseInt(Math.random()*under+1);case 2:return parseInt(Math.random()*(over-under+1)+under);default:return 0}}function showGiftDialog(giftData){var $giftDialog=$("#gift-dialog");$giftDialog.data("id",giftData.acId).data("name",giftData.acName).find(".giftName").text(giftData.acName);$giftDialog.dialog("open")}function showTipDialog(message){var $tipDialog=$("#tip-dialog");$tipDialog.find("p").text(message);$tipDialog.dialog("open")}function showInfoDialog(type){var $infoDialog=$("#info-dialog");if(type===4){$("#info-code").hide();$("#info-address").hide()}else{$("#info-code").show();$("#info-address").show()}$infoDialog.dialog("open")}var default_icon,star_01,star_02,star_03;$(function(){default_icon=$(".app").eq(0).find(".appIcon").attr("src");var $default_stars=$(".items-score").eq(0).find("img");star_01=$default_stars.eq(0).attr("src");star_02=$default_stars.eq(1).attr("src");star_03=$default_stars.eq(2).attr("src");$.ajax({url:ajaxSubjectGame.contentUrl,dataType:"jsonp",data:{"categoryId":ajaxSubjectGame.rescategory_id,"version":userInfo.version,"phonetypeName":userInfo.phonetypeName,"os_version":userInfo.os_version,"language":userInfo.language,"imei":userInfo.imei,"imsi":userInfo.imsi,"resolution":userInfo.resolution},jsonp:"jsonpSubjectDetail",success:function(data){if(data.state===1){$(".headPic").data("icon",data.ResourcesCategory.rescategoryIcons).imglazyload({"urlName":"data-icon"});$(".subjectName").text(data.ResourcesCategory.rescategoryName);$(".subjectTime").text(getDateStr(new Date(data.ResourcesCategory.rescategoryCreateddate)));$(".description").text(data.ResourcesCategory.rescategoryDescription)}},error:function(){console.log("load subject detail failed.")}});$.ajax({url:ajaxSubjectGame.appUrl,dataType:"jsonp",data:{"rescategory_id":ajaxSubjectGame.rescategory_id,"order_by":ajaxSubjectGame.order_by,"resolution":userInfo.resolution,"version":userInfo.version,"phonetypeName":userInfo.phonetypeName,"os_version":userInfo.os_version,"language":userInfo.language,"imei":userInfo.imei,"imsi":userInfo.imsi,"size":ajaxSubjectGame.init_size,"start_position":ajaxSubjectGame.start_position},jsonp:"jsonpSubjectGame",success:function(data){if(data.state===1){ajaxSubjectGame.total_size=data.products.total_size;subjectGameList=subjectGameList.concat(data.product);var $templete=$(".app").clone();var $container=$("#app-list-box").empty();var len=data.product.length;for(var i=0;i<len;++i){var $item=createItem(data.product[i],$templete);$container.append($item);$item.find(".appIcon").imglazyload({"urlName":"data-icon"});$item.find(".btn").on("tap",function(){btnTapHandler($(this));return false});$item.find(".appInfo").on("tap",function(){infoTapHandler($(this));return false})}$.fn.imglazyload.detect()}else{console.log("There is no app to load.")}},error:function(){console.log("load recommend app list error")}});$.ajax({url:ajaxSubjectGame.countUrl,dataType:"jsonp",data:{"imei":userInfo.imei,"imsi":userInfo.imsi},jsonp:"jsonpCount",success:function(data){if(data.state===1){ajaxSubjectGame.count=data.lotteryCnt;$("#lotteryCount").text(ajaxSubjectGame.count+"次")}else{console.log("return error.")}},error:function(){console.log("load lottery count error")}});$("#tip-dialog").dialog({autoOpen:false,closeBtn:false,title:"提示",buttons:{"确定":function(){this.close()}}});$("#gift-dialog").dialog({autoOpen:false,closeBtn:false,title:"礼包",buttons:{"取消":function(){this.close()},"确定":function(){var index=indexOfGift($("#gift-dialog").data("id"));if(index!=-1){isUxbao&&window.uxbao.click(JSON.stringify({"type":12,"title":$("#gift-dialog").data("name"),"url":ajaxSubjectGame.giftUrl+"?acId="+$("#gift-dialog").data("id")+"&num="+myGiftData[index].giftNo}))}else{isUxbao&&window.uxbao.click(JSON.stringify({"type":12,"title":$("#gift-dialog").data("name"),"url":ajaxSubjectGame.giftUrl+"?acId="+$("#gift-dialog").data("id")}))}this.close()}}});$("#info-dialog").dialog({autoOpen:false,closeBtn:false,title:"填写领取奖品信息",buttons:{"取消":function(){this.close()
},"确定":function(){var userName=$("#info-name").val();var phone=$("#info-phone").val();var code=$("#info-code").val();var address=$("#info-address").val();var self=this;if(prize===4){if(!userName){$("#info-name").trigger("focus");return}if(!phone){$("#info-phone").trigger("focus");return}$.ajax({url:ajaxSubjectGame.infoUrl,dataType:"jsonp",data:{"lotteryId":prizeId,"userName":userName,"userPhoneNumber":phone,"zipCode":"","userAddress":"","version":userInfo.version,"phonetypeName":userInfo.phonetypeName,"os_version":userInfo.os_version,"language":userInfo.language,"imei":userInfo.imei,"imsi":userInfo.imsi},jsonp:"jsonpInfo",success:function(data){if(data.state===1){self.close();showTipDialog("提交用户信息成功！")}else{self.close();showTipDialog("提交用户信息失败！")}},error:function(){self.close();showTipDialog("提交用户信息失败！")}})}else{if(!userName){$("#info-name").trigger("focus");return}if(!phone){$("#info-phone").trigger("focus");return}if(!code){$("#info-code").trigger("focus");return}if(!address){$("#info-address").trigger("focus");return}$.ajax({url:ajaxSubjectGame.infoUrl,dataType:"jsonp",data:{"lotteryId":prizeId,"userName":userName,"userPhoneNumber":phone,"zipCode":code,"userAddress":address,"version":userInfo.version,"phonetypeName":userInfo.phonetypeName,"os_version":userInfo.os_version,"language":userInfo.language,"imei":userInfo.imei,"imsi":userInfo.imsi},jsonp:"jsonpInfo",success:function(data){if(data.state===1){self.close();showTipDialog("提交用户信息成功！")}else{self.close();showTipDialog("提交用户信息失败！")}},error:function(){self.close();showTipDialog("提交用户信息失败！")}})}}}});var totalDeg=360*3+0;var steps=[];var prizeDeg=[330,30,90,150,210,270];var prize,prizeData,prizeId;var count=0;var now=0;var a=0.01;var inner,timer,running=false;function countSteps(){var t=Math.sqrt(2*totalDeg/a);var v=a*t;for(var i=0;i<t;i++){steps.push((2*v*i-a*i*i)/2)}steps.push(totalDeg)}function step(){inner.style.webkitTransform="rotate("+steps[now++]+"deg)";inner.style.MozTransform="rotate("+steps[now++]+"deg)";if(now<steps.length){requestAnimFrame(step)}else{running=false;if(prize===6){setTimeout(function(){showGiftDialog(prizeData)},500)}else{$("#info-dialog").data("id",prizeId);setTimeout(function(){showInfoDialog(prize)},500)}}}function start(deg){running=true;clearInterval(timer);totalDeg=360*7+deg+fRandomBy(-10,10);steps=[];now=0;countSteps();requestAnimFrame(step)}window.start=start;inner=document.getElementById("inner");i=10;$("#inner, #startBtn").tap(function(){if(running){return}$.ajax({url:ajaxSubjectGame.lotteryUrl,dataType:"jsonp",data:{"imei":userInfo.imei,"imsi":userInfo.imsi},jsonp:"jsonpLottery",success:function(data){if(data.state===-1){showTipDialog(data.message)}else{if(data.state===1){prize=data.lotteryResult;prizeId=data.lotteryId;if(data.lotteryResult===6){prizeData=data.activity}start(prizeDeg[data.lotteryResult-1])}}},error:function(){console.log("connect error")}})})});