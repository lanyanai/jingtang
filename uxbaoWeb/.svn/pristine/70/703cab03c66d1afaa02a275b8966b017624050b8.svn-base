//获取本机数据
var phoneData = window.uxbao.init();
/*var phoneData = JSON.parse(
    '{"downloadList": [' +
    '{"pName": "com.chukong.brave","percent": 30,"resId": 0,"versionCode": 2},' +
    '{"pName": "com.uxbao","percent": 20,"resId": 0,"versionCode": 4},' +
    '{"pName": "com.koogame.zaiyiqi","percent": 45,"resId": 0,"versionCode": 5}' +
    '],' +
    '"updateList": [' +
    '{"pName": "com.supreme.tanks","percent": 0,"resId": 0,"versionCode": 20},' +
    '{"pName": "org.cocos2dx.FishingJoy2","percent": 0,"resId": 0,"versionCode": 105},' +
    '{"pName": "com.TongBanStudio.JTDDZ","percent": 0,"resId": 0,"versionCode": 5}' +
    '],' +
    '"installList": [' +
    '{"pName": "cn.com.fetion","percent": 0,"resId": 0,"versionCode": 20131216},' +
    '{"pName": "com.andbase","percent": 0,"resId": 0,"versionCode": 14},' +
    '{"pName": "com.mfp.frozen.playgame.disneyck","percent": 0, "resId": 0,"versionCode": 1}' +
    ']}');*/
console.log(phoneData);

//ajax参数对象
var ajaxPara =
    {
        "total_size":0,//总共的应用个数
        "start_position":1,//从第几个开始取
        "init_size":20,//第一次取的数目
        "load_size":10,//之后每次下拉加载的数目
        "url":"http://115.29.177.196:8080/mystore/app/getrecommendproducts.do",
        "lock":false
    };

//加载进来的推荐应用列表
var recommendList = [];
//空li字符串，创建用
function createItem(itemData)
{
    var itemString = '<li id="' + itemData.resPackagename +
        '" data-url="' + itemData.resLocation +
        '" data-id="' + itemData.resId +
        '" data-package="' + itemData.resPackagename +
        '" data-icon="' + itemData.resIcons +
        '" data-name="' + itemData.resName + '">' +
        '<div class="itemAll">' +
        '<div class="appInfo">' +
        '<a href="">' +
        '<img class="appIcon" src="' + itemData.resIcons + '" />' +
        '<div class="tit">' +
        '<strong>' + itemData.resName + '</strong>' +
        '<div class="items-score">';
    //评分
    for(var i = 0; i < 5; ++i)
    {
        if(i - itemData.resRated < -0.5)
        {
            itemString += '<img alt="" src="images/jingpin/star_01.png" />';
        }
        else if(i - itemData.resRated == -0.5)
        {
            itemString += '<img alt="" src="images/jingpin/star_02.png" />';
        }
        else
        {
            itemString += '<img alt="" src="images/jingpin/star_03.png" />'
        }
    }
    itemString += '</div></div></a></div>';

    //在下载列表里
    var downloadIndex = indexList(itemData.resPackagename, phoneData.downloadList);
    if(downloadIndex != -1)
    {
        //下载完成。显示安装状态
        if(phoneData.downloadList[downloadIndex].percent == 100)
        {
            itemString += '<a class="btn installBtn" href="javascript:void(0)"><span class="state">安装</span>';
        }
        //下载未完成，显示继续
        else
        {
            itemString += '<a class="btn dlBtn" href="javascript:void(0)"><span class="state">继续</span>';
        }
    }
    //在升级列表里
    else if(indexList(itemData.resPackagename, phoneData.updateList) != -1)
    {
        itemString += '<a class="btn updateBtn" href="javascript:void(0)"><span class="state">升级</span>';
    }
    //在已安装列表
    else if(indexList(itemData.resPackagename, phoneData.installList) != -1)
    {
        itemString += '<a class="btn openBtn" href="javascript:void(0)"><span class="state">打开</span>';
    }
    //不在上述列表中
    else
    {
        itemString += '<a class="btn dlBtn" href="javascript:void(0)"><span class="state">下载</span>';
    }

    itemString += '</a></div></li>';
    return $(itemString);
}

//供android调用，更新页面的应用的状态，一种是安装包下载进度，还有就是下载完成，安装完成时
function updateState(packageName, state)
{
    var $item = $("#" + packageName);
    if(state >= 0 && state <= 100)
    {
        $item.find(".state").text(state + "%");
    }
    else if(state == "finishDownload")
    {
        $item.find(".btn").removeClass().addClass("installBtn btn");
        $item.find(".state").text("安装");
    }
    else if(state == "finishInstall")
    {
        $item.find(".btn").removeClass().addClass("openBtn btn");
        $item.find(".state").text("打开");
    }
}

//判断packageName是否在list中，在的话返回索引，不在的话返回-1
function indexList(packageName, list)
{
    var len = list.length;
    for(var i = 0; i < len; ++i)
    {
        if(packageName == list[i].pName)
        {
            return i;
        }
    }
    return -1;
}

//ajax填充打分
function fillRate($item, score)
{
    //分数
    $item.find(".items-score img").each(function(j, imgItem)
    {
        if(j - score < -0.5)
        {
            $(imgItem).attr("src", "images/jingpin/star_01.png");
        }
        else if(j - score == -0.5)
        {
            $(imgItem).attr("src", "images/jingpin/star_02.png");
        }
        else
        {
            $(imgItem).attr("src", "images/jingpin/star_03.png");
        }
    });
}

//根据本机信息填充状态
function fillState($item, packageName, phoneData)
{
    //在下载列表里
    var downloadIndex = indexList(packageName, phoneData.downloadList);
    if(downloadIndex != -1)
    {
        //下载完成。显示安装状态
        if(phoneData.downloadList[downloadIndex].percent == 100)
        {
            $item.find(".state").text("安装");
            $item.find(".btn").addClass("installBtn");
        }
        //下载未完成，显示继续
        else
        {
            $item.find(".state").text("继续");
            $item.find(".btn").addClass("dlBtn");
        }
    }
    //在升级列表里
    else if(indexList(packageName, phoneData.updateList) != -1)
    {
        $item.find(".state").text("升级");
        $item.find(".btn").addClass("updateBtn");
    }
    //在已安装列表
    else if(indexList(packageName, phoneData.installList) != -1)
    {
        $item.find(".state").text("打开");
        $item.find(".btn").addClass("openBtn");
    }
    //不在上述列表中
    else
    {
        $item.find(".state").text("下载");
        $item.find(".btn").addClass("dlBtn");
    }
}

//ajax填充一个应用的信息，$item是一个zepto对象，itemData提供填充数据
function fillItem($item, itemData)
{
    var packageName = itemData.resPackagename;
    //使用包名作为id
    $item.attr("id", itemData.resPackagename)
        .attr("data-url", itemData.resLocation)
        .attr("data-id", itemData.resId)
        .attr("data-package", packageName)
        .attr("data-icon", itemData.resIcons)
        .attr("data-name", itemData.resName);

    $item.find(".appIcon").attr("src", itemData.resIcons)
        .attr("alt", itemData.resName);

    $item.find(".tit strong").text(itemData.resName);

    //评分
    var rated = itemData.resRated;
    fillRate($item, rated);

    //状态
    fillState($item, packageName, phoneData);
}

//下拉加载更多
function forMore(more, container, ajaxPara)
{
    var totalHeight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());
    if($(document).height() <= totalHeight)
    {
        if(ajaxPara.lock)
        {
            return;
        }
        $(more).addClass("loadMore");
        ajaxPara.lock = true;
        $.ajax(
        {
            url:ajaxPara.url + '?' +
                'resolution=200*200&version=2.3&phonetypeName=N7105&os_version=4.0&language=cn&imei=00000000&imsi=00000000&size=' +
                ajaxPara.load_size + '&start_position=' + ajaxPara.start_position + '&base64=false',
            dataType:'jsonp',
            jsonp:'jsoncallback',
            success:function(data)
            {
                if(data.state === 1 && data.product)
                {
                    ajaxPara.total_size = data.products.total_size;
                    ajaxPara.start_position += ajaxPara.load_size;
                    recommendList = recommendList.concat(data.product);
                    var len = data.product.length;
                    for (var i = 0; i < len; ++i)
                    {
                        var $item = createItem(data.product[i]);
                        $(container).append($item);
                    }
                    ajaxPara.lock = false;
                }
                $(more).removeClass('loadMore');
            },
            error:function()
            {
                console.log("error");
            }
        });
    }

}

//页面加载完毕执行函数
$(function()
{
    //最开始ajax加载20个应用
    $.ajax(
    {
        url:ajaxPara.url+ '?'+
            'resolution=200*200&version=2.3&phonetypeName=N7105&os_version=4.0&language=cn&imei=00000000&imsi=00000000&size='+
            ajaxPara.init_size + '&start_position=' + ajaxPara.start_position + '&base64=false',
        dataType:'jsonp',
        jsonp:'jsoncallback',
        success:function(data)
        {
            if(data.state === 1)//获取成功
            {
                ajaxPara.total_size = data.products.total_size;
                ajaxPara.start_position += ajaxPara.init_size;
                recommendList = recommendList.concat(data.product);
                $("#app-list-box li").each(function(i,item)
                {
                    fillItem($(this), data.product[i]);
                });
            }
            else
            {
                console.log("failed to get json data.");
            }
        }
    });

    //顶部专题滑屏切换
    if(document.getElementById("slide_01"))
    {
        var slide_01 = new ScrollPic();
        slide_01.scrollContId = "slide_01"; //内容容器ID
        slide_01.dotListId = "slide_01_dot";//点列表ID
        slide_01.itemClass = "mod_01";
        slide_01.dotOnClassName = "selected";
        slide_01.frameWidth = $("body").width();
        slide_01.pageWidth = $("body").width();
        slide_01.upright = false;
        slide_01.speed = 10;
        slide_01.space = 30;
        slide_01.initialize(); //初始化
    }

    //要么下载，要么打开，要么暂停
    $('.btn').on('click', function()
    {
        var $target = $(this);
        var $item = $target.parent().parent();
        //通知android下载
        if($target.hasClass('dlBtn'))
        {
            $target.removeClass('dlBtn').addClass('cancelBtn');
            $target.find(".state").text('暂停');
            window.uxbao.click(
                {
                    "type":1,
                    "resPackagename":$item.attr("data-package"),
                    "resId":$item.attr("data-id"),
                    "resLocation":$item.attr("data-url"),
                    "resIcons":$item.arrt("data-icon"),
                    "resName":$item.attr("data-name")
                });
        }
        else if($target.hasClass('updateBtn'))
        {
            $target.removeClass('updateBtn').addClass('cancelBtn');
            $target.find(".state").text('暂停');
            window.uxbao.click(
                {
                    "type":1,
                    "resPackagename":$item.attr("data-package"),
                    "resId":$item.attr("data-id"),
                    "resLocation":$item.attr("data-url"),
                    "resIcons":$item.arrt("data-icon"),
                    "resName":$item.attr("data-name")
                });
        }
        //通知android暂停下载
        else if($target.hasClass('cancelBtn'))
        {
            $target.removeClass('cancelBtn').addClass('dlBtn');
            $target.find(".state").text('继续');
            window.uxbao.click(
                {
                    "type":5,
                    "resPackagename":$item.attr("data-package"),
                    "resId":$item.attr("data-id"),
                    "resLocation":$item.attr("data-url"),
                    "resIcons":$item.arrt("data-icon"),
                    "resName":$item.attr("data-name")
                }
            );
        }
        //通知android打开此应用
        else if($target.hasClass("openBtn"))
        {
            window.uxbao.click(
                {
                    "type":3,
                    "resPackagename":$item.attr("data-package"),
                    "resId":$item.attr("data-id"),
                    "resLocation":$item.attr("data-url"),
                    "resIcons":$item.arrt("data-icon"),
                    "resName":$item.attr("data-name")
                }
            );
        }
        //通知android安装此应用
        else if($target.hasClass("installBtn"))
        {
            window.uxbao.click(
                {
                    "type":6,
                    "resPackagename":$target.attr("data-package"),
                    "resId":$target.attr("data-id"),
                    "resLocation":$target.attr("data-url"),
                    "resIcons":$item.arrt("data-icon"),
                    "resName":$item.attr("data-name")
                }
            );
        }
    });

    //下拉加载更多
    $(window).on("swipeUp", function()
    {
        forMore(".more", "#app-list-box", ajaxPara);
    });
    $(window).on("scroll", function()
    {
        forMore(".more", "#app-list-box", ajaxPara);
    })
});
