(function(gmu,$,undefined){var tpl={close:'<a class="ui-dialog-close" title="关闭"><span class="ui-icon ui-icon-delete"></span></a>',mask:'<div class="ui-mask"></div>',title:'<div class="ui-dialog-title">'+"<h3><%=title%></h3>"+"</div>",wrap:'<div class="ui-dialog">'+'<div class="ui-dialog-content"></div>'+"<% if(btns){ %>"+'<div class="ui-dialog-btns">'+"<% for(var i=0, length=btns.length; i<length; i++){var item = btns[i]; %>"+'<a class="ui-btn ui-btn-<%=item.index%>" data-key="<%=item.key%>"><%=item.text%></a>'+"<% } %>"+"</div>"+"<% } %>"+"</div> "};gmu.define("Dialog",{options:{autoOpen:true,buttons:null,closeBtn:true,mask:true,width:300,height:"auto",title:null,content:null,scrollMove:true,container:null,maskClick:null,position:null},getWrap:function(){return this._options._wrap},_init:function(){var me=this,opts=me._options,btns,i=0,eventHanlder=$.proxy(me._eventHandler,me),vars={};me.on("ready",function(){opts._container=$(opts.container||document.body);(opts._cIsBody=opts._container.is("body"))||opts._container.addClass("ui-dialog-container");vars.btns=btns=[];opts.buttons&&$.each(opts.buttons,function(key){btns.push({index:++i,text:key,key:key})});opts._mask=opts.mask?$(tpl.mask).appendTo(opts._container):null;opts._wrap=$($.parseTpl(tpl.wrap,vars)).appendTo(opts._container);opts._content=$(".ui-dialog-content",opts._wrap);opts._title=$(tpl.title);opts._close=opts.closeBtn&&$(tpl.close).highlight("ui-dialog-close-hover");me.$el=me.$el||opts._content;me.title(opts.title);me.content(opts.content);btns.length&&$(".ui-dialog-btns .ui-btn",opts._wrap).highlight("ui-state-hover");opts._wrap.css({width:opts.width,height:opts.height});$(window).on("ortchange",eventHanlder);opts._wrap.on("click",eventHanlder);opts._mask&&opts._mask.on("click",eventHanlder);opts.autoOpen&&me.open()})},_create:function(){var opts=this._options;if(this._options.setup){opts.content=opts.content||this.$el.show();opts.title=opts.title||this.$el.attr("title")}},_eventHandler:function(e){var me=this,match,wrap,opts=me._options,fn;switch(e.type){case"ortchange":this.refresh();break;case"touchmove":opts.scrollMove&&e.preventDefault();break;case"click":if(opts._mask&&($.contains(opts._mask[0],e.target)||opts._mask[0]===e.target)){return me.trigger("maskClick")}wrap=opts._wrap.get(0);if((match=$(e.target).closest(".ui-dialog-close",wrap))&&match.length){me.close()}else{if((match=$(e.target).closest(".ui-dialog-btns .ui-btn",wrap))&&match.length){fn=opts.buttons[match.attr("data-key")];fn&&fn.apply(me,arguments)}}}},_calculate:function(){var me=this,opts=me._options,size,$win,root=document.body,ret={},isBody=opts._cIsBody,round=Math.round;opts.mask&&(ret.mask=isBody?{width:"100%",height:Math.max(root.scrollHeight,root.clientHeight)-1}:{width:"100%",height:"100%"});size=opts._wrap.offset();$win=$(window);ret.wrap={left:"50%",marginLeft:-round(size.width/2)+"px",top:isBody?round($win.height()/2)+window.pageYOffset:"50%",marginTop:-round(size.height/2)+"px"};return ret},refresh:function(){var me=this,opts=me._options,ret,action;if(opts._isOpen){action=function(){ret=me._calculate();ret.mask&&opts._mask.css(ret.mask);opts._wrap.css(ret.wrap)};if($.os.ios&&document.activeElement&&/input|textarea|select/i.test(document.activeElement.tagName)){document.body.scrollLeft=0;setTimeout(action,200)}else{action()}}return me},open:function(x,y){var opts=this._options;opts._isOpen=true;opts._wrap.css("display","block");opts._mask&&opts._mask.css("display","block");x!==undefined&&this.position?this.position(x,y):this.refresh();$(document).on("touchmove",$.proxy(this._eventHandler,this));return this.trigger("open")},close:function(){var eventData,opts=this._options;eventData=$.Event("beforeClose");this.trigger(eventData);if(eventData.defaultPrevented){return this}opts._isOpen=false;opts._wrap.css("display","none");opts._mask&&opts._mask.css("display","none");$(document).off("touchmove",this._eventHandler);return this.trigger("close")},title:function(value){var opts=this._options,setter=value!==undefined;if(setter){value=(opts.title=value)?"<h3>"+value+"</h3>":value;opts._title.html(value)[value?"prependTo":"remove"](opts._wrap);opts._close&&opts._close.prependTo(opts.title?opts._title:opts._wrap)}return setter?this:opts.title},content:function(val){var opts=this._options,setter=val!==undefined;setter&&opts._content.empty().append(opts.content=val);return setter?this:opts.content},destroy:function(){var opts=this._options,_eventHander=this._eventHandler;$(window).off("ortchange",_eventHander);$(document).off("touchmove",_eventHander);opts._wrap.off("click",_eventHander).remove();opts._mask&&opts._mask.off("click",_eventHander).remove();opts._close&&opts._close.highlight();return this.$super("destroy")}})})(gmu,gmu.$);(function(gmu,$,undefined){gmu.Dialog.register("position",{_init:function(){var opts=this._options;opts.position=opts.position||{of:opts.container||window,at:"center",my:"center"}},position:function(x,y){var opts=this._options;if(!$.isPlainObject(x)){opts.position.at="left"+(x>0?"+"+x:x)+" top"+(y>0?"+"+y:y)
}else{$.extend(opts.position,x)}return this.refresh()},_calculate:function(){var me=this,opts=me._options,position=opts.position,ret=me.origin();opts._wrap.position($.extend(position,{using:function(position){ret.wrap=position}}));return ret}})})(gmu,gmu.$);
